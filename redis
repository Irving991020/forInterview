redis
æ˜¯å•çº¿ç¨‹çš„ï¼Œçº¯å†…å­˜æ“ä½œï¼Œæ‰€ä»¥éå¸¸å¿«
æœ‰3ä¸ªæ¦‚å¿µ ç¼“å­˜ç©¿é€ ç¼“å­˜å‡»ç©¿ï¼Œç¼“å­˜é›ªå´©
1.ç¼“å­˜é›ªå´©ï¼š
é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯é›ªå´©ã€‚å¤§é‡çš„keyåŒä¸€æ—¶é—´è¿‡æœŸï¼Œå¯¼è‡´å¤§é‡çš„keyåŒä¸€æ—¶é—´å»æŸ¥åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§
è§£å†³åŠæ³•ï¼šä¸è®©keyåŒä¸€æ—¶é—´è¿‡æœŸå°±å¥½äº†ï¼Œè®¾ç½®ä¸ªæ—¶é—´+éšæœºå‡ ä¸ªåˆ†é’Ÿ
public void setWithRandomExpire(String key, String value, long time) {
        // 1. è®¡ç®—éšæœºå€¼ï¼šåœ¨åŸæ—¶é—´åŸºç¡€ä¸Šï¼Œå¢åŠ  1~5 åˆ†é’Ÿçš„éšæœºæ—¶é—´
        // è¿™æ · 100ä¸‡ä¸ª Key å°±ä¸ä¼šåœ¨åŒä¸€ç§’è¿‡æœŸäº†
        long randomTime = (long) (Math.random() * 300);
        long finalTime = time + randomTime;

        // 2. å­˜å…¥ Redis
        redisTemplate.opsForValue().set(key, value, finalTime, TimeUnit.SECONDS);
    }


2.ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyï¼Œè¿‡æœŸï¼Œå¤§é‡çš„æŸ¥è¯¢æŸ¥åº“
è§£å†³ï¼šåªå…è®¸ä¸€ä¸ªæŸ¥è¯¢ï¼Œå»æŸ¥åº“ã€‚
å¼•å…¥çœ‹é—¨ç‹—æœºåˆ¶ã€‚redissonã€‚ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦å¼•å…¥ï¼Œç„¶åæ“ä½œçš„æ—¶å€™åŠ é”å°±è¡Œäº†ï¼Œä»–ä¼šæ¯10ç§’å»æŸ¥è¯¢ä½ è¿™ä¸ªè¿‡æœŸæ—¶é—´å–ä¸šåŠ¡æ—¶é—´ã€‚
å¦‚æœä¸šåŠ¡æ—¶é—´è¿˜åœ¨è¿è¡Œï¼Œè¿‡æœŸæ—¶é—´å¿«ç»“æŸäº†ï¼Œé‚£å°±ä¼šè‡ªåŠ¨ç»­å‘½ï¼Œè‡ªåŠ¨åŠ æ—¶é—´

@Service
public class StockService {

    @Autowired
    private RedissonClient redisson; // ç›´æ¥æ³¨å…¥ Redisson å®¢æˆ·ç«¯

    public void deductStock(Long goodsId) {
        String lockKey = "lock:goods:" + goodsId;

        // 1. è·å–é”å¯¹è±¡ (è¿˜æ²¡åŠ é”ï¼Œåªæ˜¯æ‹¿ä¸ªå¼•ç”¨)
        RLock lock = redisson.gtLeock(lockKey);

        try {
            // 2. ã€æ ¸å¿ƒåŠ¨ä½œã€‘åŠ é”ï¼
            // åªè¦è¿™ä¸€è¡Œæ‰§è¡ŒæˆåŠŸï¼Œçœ‹é—¨ç‹— (Watchdog) åå°çº¿ç¨‹å°±è‡ªåŠ¨å¯åŠ¨äº†
            // é»˜è®¤æ¯ 10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œè‡ªåŠ¨å¸®ä½ ç»­å‘½ï¼Œä¸ç”¨æ‹…å¿ƒä¸šåŠ¡æ‰§è¡Œå¤ªä¹…é”è¿‡æœŸ
            lock.lock();

            // 3. æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ (æŸ¥åº“å­˜ -> å‡åº“å­˜)
            // è¿™é‡Œå·²ç»æ˜¯å•çº¿ç¨‹å®‰å…¨åŒºåŸŸäº†
            doBusiness();

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // 4. ã€å¿…é¡»ã€‘åœ¨ finally å—ä¸­é‡Šæ”¾é”
            // åªæœ‰æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”ï¼Œæ‰å»é‡Šæ”¾ (Redisson å†…éƒ¨å¸®å…¶å®ä½ åˆ¤æ–­äº†)
            if (lock.isLocked() && lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}



3.ç¼“å­˜ç©¿é€ï¼šredisæ²¡æœ‰æŸ¥åˆ°æ•°æ®ï¼Œæ•°æ®åº“ä¹Ÿæ²¡æŸ¥åˆ°ã€‚å¦‚æœç–¯ç‹‚æŸ¥
è§£å†³ï¼šå¦‚æœredisæŸ¥åˆ°æ˜¯nullï¼Œé‚£å°±å»æ•°æ®åº“æŸ¥è¯¢ã€‚æŸ¥åˆ°äº†å°±è®¾ç½®ï¼Œæ²¡æŸ¥åˆ°å°±è®¾ç½®ä¸ºç©ºã€‚å…·ä½“ä»£ç å°±æ˜¯æ˜¯nullï¼Œè¿”å›ã€‚æŸ¥åˆ°æ˜¯â€â€œ è¿”å›ã€‚æŸ¥åˆ°userï¼Œå°±è®¾ç½®åˆ°redisé‡Œ
public User getUserById(Long id) {
        String key = "user:" + id;

        // 1. å…ˆæŸ¥ç¼“å­˜
        String json = redisTemplate.opsForValue().get(key);

        // 2. å¦‚æœç¼“å­˜é‡Œæœ‰ä¸œè¥¿
        if (json != null) {
            // ã€å…³é”®ç‚¹ã€‘ï¼šåˆ¤æ–­æ˜¯ä¸æ˜¯æˆ‘ä»¬æ•…æ„å­˜çš„â€œç©ºå€¼æ ‡è®°â€ (æ¯”å¦‚ç©ºå­—ç¬¦ä¸²)
            if ("".equals(json)) {
                // æ˜¯ç©ºå€¼ï¼Œè¯´æ˜æ•°æ®åº“é‡ŒçœŸæ²¡æœ‰ï¼Œç›´æ¥è¿”å› nullï¼Œåˆ«å»éªšæ‰°æ•°æ®åº“
                return null;
            }
            // ä¸æ˜¯ç©ºå€¼ï¼Œæ­£å¸¸ååºåˆ—åŒ–è¿”å›
            return JSON.parseObject(json, User.class);
        }

        // 3. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
        User user = userMapper.selectById(id);

        // 4. æ•°æ®åº“ä¹Ÿæ²¡æŸ¥åˆ°ï¼Ÿ (é‡åˆ°äº†é»‘å®¢æ”»å‡»æˆ–è€…å†·é—¨æ•°æ®)
        if (user == null) {
            // ã€å…³é”®ä»£ç ã€‘ï¼šå­˜ä¸€ä¸ªç©ºå­—ç¬¦ä¸²è¿›å»ï¼å¹¶è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 5åˆ†é’Ÿï¼‰
            // ä¸‹æ¬¡å†æŸ¥ -1ï¼Œæ­¥éª¤ 2 å°±ä¼šæ‹¦æˆªä½
            redisTemplate.opsForValue().set(key, "", 5, TimeUnit.MINUTES);
            return null;
        }

        // 5. æ•°æ®åº“æŸ¥åˆ°äº†ï¼Œæ­£å¸¸å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(key, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
        return user;
    }


 å››ã€ è§£å†³â€œåŒå†™ä¸€è‡´æ€§â€ (Consistency)

 è¿™ä¸ªå°±å¾ˆç®€å•ï¼Œå¦‚æœæ•°æ®åº“æœ‰æ›´æ–°çš„è¯ï¼Œé‚£å°±æ›´æ–°æ•°æ®åº“ï¼Œç„¶åç›´æ¥æŠŠmysqlåˆ äº†å°±è¡Œäº†ã€‚è¿‡ç€è¿‡ä¸¤ç§’åˆ é™¤ã€‚
 // 1. ã€å…ˆã€‘æ›´æ–°æ•°æ®åº“
         userMapper.updateById(user);

         // 2. ã€åã€‘åˆ é™¤ç¼“å­˜
         // ä¸ºä»€ä¹ˆæ˜¯åˆ ï¼Œä¸æ˜¯æ›´æ–°ï¼Ÿå› ä¸ºâ€œæ‡’åŠ è½½â€æ€æƒ³ã€‚
         // ä¸‹æ¬¡æœ‰äººæŸ¥çš„æ—¶å€™ï¼Œä»–è‡ªå·±ä¼šå»æ•°æ®åº“æ‹¿æ–°çš„ï¼Œå†å¡«å…¥ç¼“å­˜ã€‚
         // è¿™æ ·é¿å…äº†ä½ é¢‘ç¹æ›´æ–°ç¼“å­˜ï¼Œç»“æœæ ¹æœ¬æ²¡äººæŸ¥ï¼Œæµªè´¹æ€§èƒ½ã€‚
         redisTemplate.delete(key);
         // 3. ã€æ ¸å¿ƒã€‘å»¶è¿Ÿä¸€ä¼šå„¿ï¼Œå†åˆ ä¸€æ¬¡
             // ä¸ºäº†é˜²æ­¢ï¼šåœ¨æ­¥éª¤2è¿˜æ²¡æäº¤çš„æ—¶å€™ï¼Œæœ‰è¯»è¯·æ±‚æŠŠè„æ•°æ®åˆè¯»è¿›ç¼“å­˜äº†
             threadPool.execute(() -> {
                 try {
                     Thread.sleep(500); // ç¡ 500ms
                     redisTemplate.delete(key); // å†åˆ ä¸€æ¬¡ï¼Œå…œåº•
                 } catch (InterruptedException e) {
                     e.printStackTrace();
                 }
             });









             è¿™æ­£æ˜¯æŠŠ Redis ç”¨æ´»çš„å…³é”®ã€‚

             é™¤äº†åˆšæ‰è®²çš„â€œç¼“å­˜ä¸‰ç¾â€å’Œâ€œåˆ†å¸ƒå¼é”â€è¿™ç§ä¿å‘½å‹åœºæ™¯ï¼ŒRedis åœ¨ä¸šåŠ¡ä¸­å…¶å®è¿˜æœ‰ 5 ä¸ªéå¸¸ç»å…¸çš„åŠŸèƒ½å‹åœºæ™¯ã€‚

             æˆ‘æŠŠè¿™äº›åœºæ™¯çš„ä¸šåŠ¡èƒŒæ™¯ã€åº•å±‚æ•°æ®ç»“æ„å’Œç”Ÿäº§çº§ä»£ç éƒ½ç»™ä½ æ•´ç†å¥½äº†ã€‚è¿™ä¸ä»…æ˜¯é¢è¯•åŠ åˆ†é¡¹ï¼Œæ›´æ˜¯ä½ å·¥ä½œä¸­è§£å†³æ£˜æ‰‹é—®é¢˜çš„ç‘å£«å†›åˆ€ã€‚

             åœºæ™¯ä¸€ï¼šå®æ—¶æ’è¡Œæ¦œ (Leaderboard)
             ä¸šåŠ¡èƒŒæ™¯ï¼š ç›´æ’­é—´çš„â€œæ¦œä¸€å¤§å“¥â€ã€æ¸¸æˆçš„â€œæˆ˜åŠ›æ¦œâ€ã€ç”µå•†çš„â€œçƒ­é”€æ¦œâ€ã€‚

             åº•å±‚ç»“æ„ï¼š ZSet (Sorted Set)ã€‚å®ƒè‡ªåŠ¨æ ¹æ®åˆ†æ•°æ’åºï¼Œæ•ˆç‡æé«˜ã€‚

             æ ¸å¿ƒå‘½ä»¤ï¼š ZADD (åŠ åˆ†), ZREVRANGE (æŸ¥å‰å‡ å)ã€‚

             ç”Ÿäº§ä»£ç  (RankingService):

             Java

             @Service
             public class RankingService {

                 @Autowired
                 private StringRedisTemplate redisTemplate;

                 private static final String RANK_KEY = "game:rank:daily";

                 /**
                  * 1. ç©å®¶ä¸Šåˆ†
                  * @param userId ç”¨æˆ·ID
                  * @param score åˆ†æ•°
                  */
                 public void addScore(Long userId, double score) {
                     // ZADD game:rank:daily 100 1001
                     // æ³¨æ„ï¼šå¦‚æœæ˜¯â€œç´¯åŠ åˆ†æ•°â€ï¼Œå¯ä»¥ä½¿ç”¨ incrementScore
                     redisTemplate.opsForZSet().incrementScore(RANK_KEY, String.valueOf(userId), score);
                 }

                 /**
                  * 2. è·å–å‰ 10 å (Top 10)
                  * @return åŒ…å«ç”¨æˆ·IDå’Œåˆ†æ•°çš„åˆ—è¡¨
                  */
                 public List<Map<String, Object>> getTop10() {
                     // ZREVRANGE game:rank:daily 0 9 WITHSCORES
                     // reverseRange è¡¨ç¤ºä»å¤§åˆ°å°æ’ (å€’åº)
                     Set<ZSetOperations.TypedTuple<String>> set =
                         redisTemplate.opsForZSet().reverseRangeWithScores(RANK_KEY, 0, 9);

                     List<Map<String, Object>> list = new ArrayList<>();
                     if (set != null) {
                         for (ZSetOperations.TypedTuple<String> tuple : set) {
                             Map<String, Object> map = new HashMap<>();
                             map.put("userId", tuple.getValue()); // ç”¨æˆ·ID
                             map.put("score", tuple.getScore());  // åˆ†æ•°
                             list.add(map);
                         }
                     }
                     return list;
                 }
             }
             åœºæ™¯äºŒï¼šå»¶æ—¶é˜Ÿåˆ— (Delayed Queue) â€”â€” è®¢å•è¶…æ—¶å–æ¶ˆ
             ä¸šåŠ¡èƒŒæ™¯ï¼š ç”¨æˆ·ä¸‹å•åï¼Œ30åˆ†é’Ÿæ²¡ä»˜æ¬¾ï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•ã€‚

             å®ç°æ–¹å¼ï¼š ä¸è¦ç”¨ RabbitMQ çš„æ­»ä¿¡é˜Ÿåˆ—ï¼ˆå¤ªé‡ï¼‰ï¼Œä¹Ÿä¸è¦ç”¨ Redis ZSet è½®è¯¢ï¼ˆä»£ç å¤æ‚ï¼‰ã€‚ç›´æ¥ç”¨ Redissonï¼

             åº•å±‚åŸç†ï¼š Redisson å°è£…äº† ZSet + å®¢æˆ·ç«¯è½®è¯¢ï¼Œåšæˆäº†é˜»å¡é˜Ÿåˆ—çš„æ ·å­ã€‚

             ç”Ÿäº§ä»£ç  (OrderDelayService):

             Java

             @Service
             public class OrderDelayService {

                 @Autowired
                 private RedissonClient redisson;

                 /**
                  * 1. å‘é€å»¶æ—¶æ¶ˆæ¯ (ä¸‹å•æ—¶è°ƒç”¨)
                  */
                 public void addDelayOrder(Long orderId) {
                     // è·å–ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—
                     RBlockingQueue<Long> blockingQueue = redisson.getBlockingQueue("order:cancel:queue");
                     // è·å–å¯¹åº”çš„å»¶æ—¶é˜Ÿåˆ—
                     RDelayedQueue<Long> delayedQueue = redisson.getDelayedQueue(blockingQueue);

                     // ã€æ ¸å¿ƒä»£ç ã€‘30åˆ†é’Ÿåï¼Œè¿™ä¸ª orderId æ‰ä¼šè‡ªåŠ¨è¿›å…¥ blockingQueue
                     delayedQueue.offer(orderId, 30, TimeUnit.MINUTES);

                     System.out.println("è®¢å• " + orderId + " å·²åŠ å…¥å»¶æ—¶é˜Ÿåˆ—ï¼Œ30åˆ†é’Ÿåè¿‡æœŸ");
                 }

                 /**
                  * 2. ç›‘å¬å¹¶å¤„ç† (ç³»ç»Ÿå¯åŠ¨æ—¶å¼€å¯ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´è·‘)
                  */
                 @PostConstruct
                 public void startConsumer() {
                     new Thread(() -> {
                         RBlockingQueue<Long> blockingQueue = redisson.getBlockingQueue("order:cancel:queue");
                         while (true) {
                             try {
                                 // ã€æ ¸å¿ƒä»£ç ã€‘take() æ˜¯é˜»å¡çš„ã€‚é˜Ÿåˆ—æ²¡æ•°æ®å°±å¡ä½ï¼Œæœ‰æ•°æ®ç¬é—´å”¤é†’ã€‚
                                 Long orderId = blockingQueue.take();

                                 System.out.println("æ”¶åˆ°è¿‡æœŸè®¢å•ï¼Œå‡†å¤‡å–æ¶ˆï¼š" + orderId);
                                 // æ‰§è¡Œå–æ¶ˆè®¢å•çš„ SQL ...

                             } catch (InterruptedException e) {
                                 e.printStackTrace();
                             }
                         }
                     }).start();
                 }
             }
             åœºæ™¯ä¸‰ï¼šç”¨æˆ·ç­¾åˆ° / åœ¨çº¿çŠ¶æ€ (BitMap)
             ä¸šåŠ¡èƒŒæ™¯ï¼š è®°å½•ç”¨æˆ·å…¨å¹´çš„ç­¾åˆ°è®°å½•ï¼Œæˆ–è€…ç»Ÿè®¡â€œæ—¥æ´»(DAU)â€ã€‚æ•°æ®é‡æå¤§ã€‚

             åº•å±‚ç»“æ„ï¼š Bitmap (ä½å›¾)ã€‚

             åŸç†ï¼šç”¨ 0 å’Œ 1 è®°å½•ã€‚1 ä¸ªå­—èŠ‚èƒ½å­˜ 8 å¤©çš„çŠ¶æ€ã€‚365 å¤©åªéœ€è¦ 46 ä¸ªå­—èŠ‚ï¼Œæçœå†…å­˜ã€‚

             æ ¸å¿ƒå‘½ä»¤ï¼š SETBIT, BITCOUNT, GETBITã€‚

             ç”Ÿäº§ä»£ç  (SignService):

             Java

             @Service
             public class SignService {

                 @Autowired
                 private StringRedisTemplate redisTemplate;

                 /**
                  * 1. ç”¨æˆ·ç­¾åˆ°
                  * Key æ ¼å¼ï¼šsign:userId:yyyyMM (æŒ‰æœˆå­˜å‚¨)
                  */
                 public void doSign(Long userId) {
                     // è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤© (1-31)
                     int dayOfMonth = LocalDate.now().getDayOfMonth();

                     // Redis çš„ offset æ˜¯ä» 0 å¼€å§‹çš„ï¼Œæ‰€ä»¥è¦ -1
                     int offset = dayOfMonth - 1;

                     String key = "sign:" + userId + ":" + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMM"));

                     // SETBIT key offset 1
                     // æŠŠè¿™æŸä¸€ä½è®¾ä¸º 1ï¼Œè¡¨ç¤ºå·²ç­¾åˆ°
                     redisTemplate.opsForValue().setBit(key, offset, true);
                 }

                 /**
                  * 2. æ£€æŸ¥ä»Šå¤©æ˜¯å¦ç­¾åˆ°
                  */
                 public boolean checkSign(Long userId) {
                     int dayOfMonth = LocalDate.now().getDayOfMonth();
                     String key = "sign:" + userId + ":" + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMM"));

                     // GETBIT key offset
                     return redisTemplate.opsForValue().getBit(key, dayOfMonth - 1);
                 }

                 /**
                  * 3. ç»Ÿè®¡æœ¬æœˆç­¾åˆ°äº†å¤šå°‘æ¬¡
                  */
                 public long countSign(Long userId) {
                     String key = "sign:" + userId + ":" + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMM"));

                     // BITCOUNT key
                     // è¿™ä¸€æ­¥éœ€é…åˆ executeï¼Œå› ä¸º RedisTemplate åŸç”Ÿæ–¹æ³•å¯¹ bitcount æ”¯æŒæœ‰é™
                     return redisTemplate.execute((RedisCallback<Long>) connection ->
                         connection.bitCount(key.getBytes())
                     );
                 }
             }
             åœºæ™¯å››ï¼šAPI é™æµ (Rate Limiter)
             ä¸šåŠ¡èƒŒæ™¯ï¼š é˜²æ­¢æ¶æ„åˆ·æ¥å£ã€‚æ¯”å¦‚â€œçŸ­ä¿¡æ¥å£æ¯åˆ†é’Ÿåªèƒ½å‘ 1 æ¬¡â€ã€â€œæŠ¢è´­æ¥å£æ¯ç§’åªè®¸ 1000 äººè®¿é—®â€ã€‚

             å®ç°æ–¹å¼ï¼š è¿˜æ˜¯ç”¨ Redissonã€‚ä¸è¦è‡ªå·±å†™ Lua è„šæœ¬ï¼ˆå®¹æ˜“å†™é”™ï¼‰ã€‚

             åº•å±‚åŸç†ï¼š ä»¤ç‰Œæ¡¶ç®—æ³• (Token Bucket)ã€‚

             ç”Ÿäº§ä»£ç  (RateLimitService):

             Java

             @Service
             public class RateLimitService {

                 @Autowired
                 private RedissonClient redisson;

                 /**
                  * å°è¯•è®¿é—®æ¥å£
                  * @param userId ç”¨æˆ·ID
                  * @return true=å…è®¸è®¿é—®ï¼Œfalse=è¢«é™æµ
                  */
                 public boolean tryAccess(Long userId) {
                     // å®šä¹‰ä¸€ä¸ªé™æµå™¨ï¼ŒKey å¯ä»¥æ˜¯æ¥å£åï¼Œä¹Ÿå¯ä»¥æ˜¯ "æ¥å£å+IP"
                     RRateLimiter rateLimiter = redisson.getRateLimiter("sms:limit:" + userId);

                     // åˆå§‹åŒ–ï¼šæ¯ 1 åˆ†é’Ÿäº§ç”Ÿ 1 ä¸ªä»¤ç‰Œ
                     // RateType.OVERALL: å…¨å±€é™æµ
                     // RateIntervalUnit.MINUTES: å•ä½åˆ†é’Ÿ
                     rateLimiter.trySetRate(RateType.OVERALL, 1, 1, RateIntervalUnit.MINUTES);

                     // å°è¯•è·å– 1 ä¸ªä»¤ç‰Œ
                     // acquire() æ˜¯é˜»å¡çš„ï¼ŒtryAcquire() æ˜¯éé˜»å¡çš„
                     return rateLimiter.tryAcquire(1);
                 }
             }
             åœºæ™¯äº”ï¼šè´­ç‰©è½¦ (Cart)
             ä¸šåŠ¡èƒŒæ™¯ï¼š æ²¡ç™»å½•æ—¶ï¼Œè´­ç‰©è½¦å­˜åœ¨ Cookie é‡Œï¼›ç™»å½•åï¼Œè´­ç‰©è½¦å­˜åœ¨ Redis é‡Œã€‚

             åº•å±‚ç»“æ„ï¼š Hash (Map<String, Map<String, String>>)ã€‚

             Key: cart:userId

             HashKey: goodsId

             Value: count (æ•°é‡)

             ä¼˜åŠ¿ï¼š å¯ä»¥å•ç‹¬ä¿®æ”¹æŸä»¶å•†å“çš„æ•°é‡ï¼Œä¸éœ€è¦æŠŠæ•´ä¸ªè´­ç‰©è½¦åºåˆ—åŒ–æ‹¿å‡ºæ¥æ”¹å®Œå†å¡å›å»ã€‚

             ç”Ÿäº§ä»£ç  (CartService):

             Java

             @Service
             public class CartService {

                 @Autowired
                 private StringRedisTemplate redisTemplate;

                 /**
                  * æ·»åŠ è´­ç‰©è½¦
                  */
                 public void addCart(Long userId, Long goodsId, int num) {
                     String key = "cart:" + userId;
                     String hashKey = String.valueOf(goodsId);

                     // HINCRBY key field increment
                     // ä¹Ÿå°±æ˜¯ï¼šcart.get(userId).get(goodsId) += num
                     redisTemplate.opsForHash().increment(key, hashKey, num);
                 }

                 /**
                  * è·å–è´­ç‰©è½¦æ‰€æœ‰å•†å“
                  */
                 public Map<Object, Object> getCart(Long userId) {
                     String key = "cart:" + userId;
                     // HGETALL key
                     return redisTemplate.opsForHash().entries(key);
                 }
             }
             ğŸ’¡ 5å¹´ç»éªŒæ€»ç»“
             é¢è¯•å®˜é—®ï¼šâ€œä½ é¡¹ç›®é‡Œ Redis ç”¨æ¥å¹²å˜›äº†ï¼Ÿâ€

             è¯·æŠ›å¼ƒï¼š â€œå°±åšäº†ä¸ªç¼“å­˜ï¼Œå­˜ä¸€ä¸‹ User å¯¹è±¡ã€‚â€ (å¤ªåˆçº§)

             è¯·å›ç­”ï¼š

             â€œé™¤äº†å¸¸è§„çš„çƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼ˆé˜²ç©¿é€/é›ªå´©ï¼‰å’Œåˆ†å¸ƒå¼é”ï¼Œæˆ‘ä»¬è¿˜æ·±åº¦ä½¿ç”¨äº† Redis çš„å¤šç§æ•°æ®ç»“æ„ï¼š

             ä½¿ç”¨ ZSet å®ç°äº†å•†å“çš„å®æ—¶çƒ­é”€æ’è¡Œæ¦œã€‚

             ç»“åˆ Redisson å®ç°äº†è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆçš„å»¶æ—¶é˜Ÿåˆ—ã€‚

             åˆ©ç”¨ Bitmap å®ç°äº†ç”¨æˆ·åƒä¸‡çº§æ•°æ®çš„ç­¾åˆ°ç»Ÿè®¡ï¼Œæå¤§èŠ‚çœäº†å­˜å‚¨ç©ºé—´ã€‚

             åœ¨é«˜å¹¶å‘æ¥å£ä¸Šï¼Œä½¿ç”¨äº† Redisson çš„ RateLimiter åšåˆ†å¸ƒå¼é™æµã€‚â€

             è¿™ 5 ä¸ªä»£ç ç‰‡æ®µï¼ŒåŸºæœ¬ä¸Šè¦†ç›–äº† 90% çš„ Redis é«˜çº§ç©æ³•ã€‚ä½ èƒ½æŠŠè¿™äº›èå…¥åˆ°ä½ çš„é¡¹ç›®é‡Œå—ï¼Ÿ